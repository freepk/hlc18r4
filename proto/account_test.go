package proto

import (
	"bytes"
	"testing"
)

var (
	testAccount = []byte(`{"sex": "f", "interests": ["\u0422\u044f\u0436\u0451\u043b\u0430\u044f \u0430\u0442\u043b\u0435\u0442\u0438\u043a\u0430"],
		"city": "\u041d\u043e\u0432\u043e\u0434\u043e\u0440\u0444", "joined": 1351641600, "likes": [{"ts": 1463495499, "id": 18911}, {"ts": 1511840264, "id": 15841},
		{"ts": 1470981073, "id": 703}, {"ts": 1463154308, "id": 7091}, {"ts": 1481910326, "id": 23339}, {"ts": 1522287113, "id": 10475}, {"ts": 1458344845, "id": 687},
		{"ts": 1533361603, "id": 10743}, {"ts": 1474885097, "id": 1373}, {"ts": 1510568100, "id": 13515}, {"ts": 1494085987, "id": 27497}, {"ts": 1505459212, "id": 8833},
		{"ts": 1464121060, "id": 17765}, {"ts": 1517239364, "id": 20617}, {"ts": 1533291937, "id": 16953}, {"ts": 1494074629, "id": 23465}, {"ts": 1485226561, "id": 10303},
		{"ts": 1526168297, "id": 6071}, {"ts": 1513881671, "id": 20291}, {"ts": 1488330474, "id": 4547}, {"ts": 1539300359, "id": 22739}, {"ts": 1533663516, "id": 24049},
		{"ts": 1524010682, "id": 16067}, {"ts": 1541254331, "id": 3495}, {"ts": 1486187843, "id": 4949}, {"ts": 1511783593, "id": 20407}, {"ts": 1457599799, "id": 6655},
		{"ts": 1527086178, "id": 11831}, {"ts": 1495410748, "id": 1145}, {"ts": 1490348585, "id": 8941}, {"ts": 1461650631, "id": 24587}, {"ts": 1468505226, "id": 4703},
		{"ts": 1500718062, "id": 14201}, {"ts": 1485023290, "id": 8169}, {"ts": 1505862664, "id": 13745}, {"ts": 1503165556, "id": 8429}, {"ts": 1527675300, "id": 26435},
		{"ts": 1541342375, "id": 22213}, {"ts": 1498736425, "id": 23471}, {"ts": 1507047303, "id": 5297}, {"ts": 1538294557, "id": 26485}, {"ts": 1481995066, "id": 3353},
		{"ts": 1455571821, "id": 5149}, {"ts": 1466534266, "id": 19109}, {"ts": 1483676974, "id": 10663}, {"ts": 1473044100, "id": 2267}, {"ts": 1498637009, "id": 21269},
		{"ts": 1453559696, "id": 26931}, {"ts": 1465181458, "id": 22711}, {"ts": 1532478611, "id": 2681}, {"ts": 1490843698, "id": 479}, {"ts": 1472428764, "id": 13043},
		{"ts": 1533655033, "id": 22877}, {"ts": 1462365272, "id": 14623}, {"ts": 1504569673, "id": 16055}, {"ts": 1469141463, "id": 16051}, {"ts": 1456102330, "id": 861},
		{"ts": 1489336347, "id": 26615}, {"ts": 1512541672, "id": 12495}, {"ts": 1539851853, "id": 9315}, {"ts": 1493223185, "id": 1769}, {"ts": 1483984049, "id": 5599},
		{"ts": 1511362077, "id": 3149}, {"ts": 1491762913, "id": 13419}, {"ts": 1511995144, "id": 17503}, {"ts": 1516007906, "id": 20757}, {"ts": 1455128932, "id": 28335},
		{"ts": 1491867849, "id": 12323}, {"ts": 1461200310, "id": 24193}],  "sname": "\u041a\u0438\u0441\u0430\u0442\u043e\u043a\u0430\u044f",
		"status": "\u0432\u0441\u0451 \u0441\u043b\u043e\u0436\u043d\u043e", "fname": "\u0415\u043a\u0430\u0442\u0435\u0440\u0438\u043d\u0430",
		"email": "niirfefrenodavto@yandex.ru", "birth": 639733065, "id": 20004}`)
)

func TestAccountUnmarshalJSON(t *testing.T) {
	acc := &Account{}
	_, ok := acc.UnmarshalJSON(testAccount)
	if !ok {
		t.Fail()
	}
	fields := (1 << 20) - 1
	buf := &bytes.Buffer{}
	acc.WriteJSON(fields, buf)
	t.Log(string(buf.Bytes()))
}

func BenchmarkAccountReset(b *testing.B) {
	acc := &Account{}
	for i := 0; i < b.N; i++ {
		acc.reset()
	}
}

func BenchmarkAccountUnmarshalJSON(b *testing.B) {
	acc := &Account{}
	for i := 0; i < b.N; i++ {
		_, ok := acc.UnmarshalJSON(testAccount)
		if !ok {
			b.Fatal()
		}
	}
}

func BenchmarkAccountMarshalJSON(b *testing.B) {
	acc := &Account{}
	_, ok := acc.UnmarshalJSON(testAccount)
	if !ok {
		b.Fatal("UnmarshalJSON error")
	}
	fields := (1 << 20) - 1
	buf := &bytes.Buffer{}
	for i := 0; i < b.N; i++ {
		buf.Reset()
		acc.WriteJSON(fields, buf)
	}
}
